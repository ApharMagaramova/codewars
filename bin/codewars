#!/usr/bin/env node

var fs = require("fs"),
    argv = require('minimist')(
      process.argv.slice(2), { alias: { h: 'help', t: 'token', l: 'language' } }
    ),
    codewars = require("../"),
    command  = argv._[0],
    log = function() { return console.log.apply(console, arguments); };

argv.language = (argv.language || "javascript").toLowerCase();

if (argv.help){
  fs.createReadStream(__dirname + '/usage.txt').pipe(process.stdout);
  return;
}

if (command === "setup"){
  if (!argv.token) {
    log("setup failed, missing required argument: token")
    log("read your token here: https://www.codewars.com/users/edit")
    process.exit(1);
  }
  if (!/javascript|ruby/.test(argv.language)){
    log("setup failed, unsupported language: " + argv.language);
  }
  codewars().setup({
    language: argv.language,
    token: argv.token
  });

  process.exit(0);
}

if (command === "test"){
  codewars().test().then(function(){
    log('Success - ready to rumble!');
    process.exit(0);
  }, function(response){
    var status = response.statusCode,
        body   = response.raw.toString('utf-8');

    log('Oh noes! Something is wrong.\n');
    log('Status: ' + status);
    log('Body:  ' + body);
    process.exit(1);
  });
}

if (command === "next"){
  codewars().next().then(function(data){
    var challenge = require('../challenge')(data.raw.toString('utf-8')),
        msee      = require("msee");
    log(msee.parse(challenge.toString()));
  });
}
